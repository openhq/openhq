
<h1>
  {{ story.name }}
  <small><a href="/projects/{{ story.project.slug }}">{{ story.project.name }}</a></small>
</h1>

<div class="pure-g">

  <div class="pure-u-1 pure-u-md-17-24 ui-story-container">
    <div class="ui-story">
      <article>
        <header>
          <div class="actions">
            <a href="#">Edit</a>
          </div>
          <user-avatar user="story.owner"></user-avatar>
          {{ story.owner.display_name }} added <human-time datetime="story.created_at"></human-time>
        </header>
        <section class="body" ng-bind-html="story.markdown">
        </section>
      </article>

      <div class="tasks">
        <div ng-hide="story.tasks.length > 0" class="no-tasks">
          <h4>No Tasks</h4>
        </div>
        <div ng-show="story.tasks.length > 0" class="tasks-list-container">
          <h4>{{ story.tasks.length }} Incomplete Tasks</h4>
          <ul class="sortable">
            <li ng-repeat="task in story.tasks">
              <task-item task="task" users="story.users_select_array"></task-item>
            </li>
          </ul>
        </div>

        <form class="pure-form pure-form-stacked" novalidate ng-submit="createTask(newTask)">
          <input autocomplete="off" class="atwho" placeholder="Add a new task..." type="text" ng-model="newTask.label">

          <div class="pure-g">
            <div class="pure-u-1 pure-u-md-11-24">
              <div class="input select optional task_assignment">
                <select ng-model="newTask.assigned_to" ng-options="user[1] as user[0] for user in story.users_select_array"></select>
              </div>
            </div>
            <div class="pure-u-1 pure-u-md-3-24 due-label">Due:</div>
            <div class="pure-u-1 pure-u-md-10-24">
              <input class="task_due_at hasDatepicker" type="text" ng-model="newTask.due_at">
            </div>
          </div>

          <input type="submit" value="Create Task" class="btn btn-main btn-small">
        </form>
      </div>

      <div class="attachments">
        <p ng-hide="story.attachments.length">No attachments</p>

        <ul class="file-list" ng-show="story.attachments.length">
          <li ng-repeat="attachment in story.attachments">
            <div class="attachment-file">
              <a href="{{ attachment.url }}" target="_blank" title="{{ attachment.file_name }}">
                <div class="file-preview">
                  <img src="{{ attachment.preview_url }}" alt="{{ attachment.file_name }}" width="59">
                </div>
                <span class="file-name">{{ attachment.file_name | limitTo : 20 }}</span>
                <span class="file-size">{{ attachment.human_file_size }}</span>
              </a>
            </div>
          </li>
        </ul>
      </div>
      <article ng-repeat="comment in story.comments" class="comment-row">
        <header>
          <div class="actions">
            <a href="#">Edit</a>
            | <a href="#">Delete</a>
          </div>
          <user-avatar user="comment.owner"></user-avatar>

          {{ comment.owner.display_name }} added <human-time datetime="comment.created_at"></human-time>
        </header>
        <section class="body comment">

          <div ng-bind-html="comment.markdown"></div>

          <div ng-show="comment.attachments.length">
            <h5>Added
              <ng-pluralize count="comment.attachments.length"
                 when="{'0': 'no attachments',
                      'one': 'an attachment',
                      'other': '{} attachments'}">
              </ng-pluralize>
            </h5>
            <ul class="comment-files-list">
              <li ng-repeat="attachment in comment.attachments">
                <div class="attachment-preview">
                  <a href="{{ attachment.url }}" target="_blank" title="{{ attachment.file_name }}">
                    <div class="image-preview">
                      <img src="{{ attachment.preview_url }}">
                    </div>
                    <span class="file-name">{{ attachment.file_name | limitTo : 20 }}</span>
                    <span class="file-size">{{ attachment.human_file_size }}</span>
                  </a>
                </div>
              </li>
            </ul>
          </div>

        </section>
      </article>
      <div class="add-comment content-input">
        <header class="plain">
          <user-avatar user="currentUser"></user-avatar> Reply to this topic
        </header>
        <form class="pure-form pure-form-stacked" ng-submit="createComment(newComment)">
          <markdown-input content="newComment.content" filler="'Type your message'"></markdown-input>

          <footer>
            <button class="btn btn-secondary btn-with-icon attach-files" ngf-select="upload($files)" ngf-multiple="true">
              <span class="icon icon-disk"></span>
              Attach files
            </button>
            <button class="btn btn-main">Reply</button>
          </footer>
        </form>
      </div>

      <div ng-show="fileUploads.length">
        <upload-progress class="upload-progress" ng-repeat="upload in fileUploads" file="upload">
        </upload-progress>
      </div>
    </div>

  </div>

  <div class="pure-u-1 pure-u-md-6-24">
    <aside class="story-menu">
      <ul class="plain-list actions-list">
        <li>
          <a href="#" class="icon-link link-large">
            <span class="icon icon-bell"></span>
            Disable Notifications
          </a>
        </li>
        <li>
          <a href="/stories/{{ story.slug }}/archive" class="icon-link link-large danger">
            <span class="icon icon-trash"></span>
            Archive this story
          </a>
        </li>
      </ul>


      <h4>
        <ng-pluralize count="collaborators.length"
                 when="{'0': 'No Contributors',
                      'one': '1 Contributor',
                      'other': '{} Contributors'}">
        </ng-pluralize>
      </h4>

      <div class="members">
        <user-avatar user="user" ng-repeat="user in collaborators"></user-avatar>
      </div>

      <div class="overall-task-progress">
        <h4>Task progress</h4>
        <div class="progress-bar">
          <span class="completion"></span>
        </div>
      </div>

      <h4>0 Attachments</h4>
    </aside>
  </div>

</div>
